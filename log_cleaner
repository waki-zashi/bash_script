#!/bin/bash
if [ $# -ne 2 ]; then
    echo "Usage: $0 <log_directory> <threshold_size_MB>" 
    exit 1
fi

LOG_DIR=$1
THRESHOLD_MB=$2
BACKUP_DIR="$HOME/backup"
N=70 

if ! [[ "$THRESHOLD_MB" =~ ^[0-9]+$ ]]; then
    echo "Error: Threshold must be a number" 
    exit 1
fi

if [ "$THRESHOLD_MB" -le 0 ]; then 
    echo "Error: Threshold must be greater than 0" 
    exit 1
fi

if [ ! -d "$LOG_DIR" ]; then
    echo "Error: Directory $LOG_DIR does not exist" 
    exit 2
fi

if [ ! -d "$BACKUP_DIR" ]; then
    echo "Directory $BACKUP_DIR not found, creating..." 
    mkdir -p "$BACKUP_DIR"
fi

FOLDER_SIZE_MB=$(du -sm "$LOG_DIR" | cut -f1)

THRESHOLD_N=$((THRESHOLD_MB * N / 100))
echo "Directory $LOG_DIR size: ${FOLDER_SIZE_MB}MB"
echo "Threshold: ${THRESHOLD_MB}MB (action triggered at ${THRESHOLD_N}MB)"

if [ $FOLDER_SIZE_MB -gt $THRESHOLD_N ]; then
    echo "Threshold ${THRESHOLD_N}MB exceeded. Starting archive..."

    M=0
    FILES_TO_ARCHIVE=()
    
    while IFS= read -r -d '' file; do
        FILES_TO_ARCHIVE+=("$file")
    done < <(find "$LOG_DIR" -type f -printf "%T@ %p\0" | sort -zn | cut -zd' ' -f2-)
    
    if [ ${#FILES_TO_ARCHIVE[@]} -eq 0 ]; then
        echo "No files to archive."
        exit 0
    fi

    ARCHIVED_FILES=()
    CURRENT_SIZE=$FOLDER_SIZE_MB
    
    for file in "${FILES_TO_ARCHIVE[@]}"; do
        CURRENT_SIZE=$(du -sm "$LOG_DIR" | cut -f1)
        
        if [ $CURRENT_SIZE -le $THRESHOLD_N ]; then
            break
        fi
        
        ARCHIVE_NAME="$BACKUP_DIR/Log_backup_$(date +%Y%m%d_%H%M%S)_$M.tar.gz"
        echo "Archiving: $file"
        
        (cd "$LOG_DIR" && tar -czf "$ARCHIVE_NAME" -- "${file#$LOG_DIR/}")
        
        if [ $? -eq 0 ]; then
            ARCHIVED_FILES+=("$file")
            rm -f "$file"
            M=$((M + 1))
            echo "Successfully archived $file"
        else
            echo "Failed to archive $file"
            continue
        fi
    done

    if [ ${#ARCHIVED_FILES[@]} -eq 0 ]; then
        echo "No files were archived."
    else
        echo "Archive completed successfully. Archived $M files."
        echo "Current directory size: ${CURRENT_SIZE}MB"
    fi
else
    echo "Threshold not exceeded. No action needed."
fi

exit 0
