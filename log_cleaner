#!/bin/bash
if [ $# -ne 2 ]; then
    echo "Usage: $0 <log_directory> <threshold_percentage>" 
    exit 1
fi

LOG_DIR=$1
THRESHOLD=$2
BACKUP_DIR="$HOME/backup"
N=70

if ! [[ "$THRESHOLD" =~ ^[0-9]+$ ]]; then
    echo "Error: Threshold must be a number between 0 and 100" 
    exit 1
fi

if [ "$THRESHOLD" -lt 0 ] || [ "$THRESHOLD" -gt 100 ]; then 
    echo "Error: Threshold must be between 0 and 100" 
    exit 1
fi

if [ ! -d "$LOG_DIR" ]; then
    echo "Error: Directory $LOG_DIR does not exist" 
    exit 2
fi

if [ ! -d "$BACKUP_DIR" ]; then
    echo "Directory $BACKUP_DIR not found, creating..." 
    mkdir -p "$BACKUP_DIR"
fi

USAGE_PERCENT=$(df "$LOG_DIR" | awk 'NR==2 {gsub(/%/, "", $5); print $5}')

THRESHOLD_N=$((THRESHOLD * N / 100))

echo "Directory $LOG_DIR uses $USAGE_PERCENT% of filesystem space"
echo "Threshold: $THRESHOLD% (action triggered at ${THRESHOLD_N}%)"

if [ $USAGE_PERCENT -gt $THRESHOLD_N ]; then
    echo "Threshold $THRESHOLD% exceeded. Starting archive..."

    M=0
    FILES_TO_ARCHIVE=()
    
    while IFS= read -r -d '' file; do
        FILES_TO_ARCHIVE+=("$file")
    done < <(find "$LOG_DIR" -type f -printf "%T@ %p\0" | sort -zn | cut -zd' ' -f2-)
    
    if [ ${#FILES_TO_ARCHIVE[@]} -eq 0 ]; then
        echo "No files to archive."
        exit 0
    fi

    ARCHIVED_FILES=()
    CURRENT_USAGE=$USAGE_PERCENT
    
    for file in "${FILES_TO_ARCHIVE[@]}"; do
        CURRENT_USAGE=$(df "$LOG_DIR" | awk 'NR==2 {gsub(/%/, "", $5); print $5}')
        
        if [ $CURRENT_USAGE -le $THRESHOLD_N ]; then
            break
        fi
        
        ARCHIVE_NAME="$BACKUP_DIR/Log_backup_$(date +%Y%m%d_%H%M%S)_$M.tar.gz"
        echo "Archiving: $file"
        
        (cd "$LOG_DIR" && tar -czf "$ARCHIVE_NAME" -- "${file#$LOG_DIR/}")
        
        if [ $? -eq 0 ]; then
            ARCHIVED_FILES+=("$file")
            rm -f "$file"
            M=$((M + 1))
            echo "Successfully archived $file"
        else
            echo "Failed to archive $file"
            continue
        fi
    done

    if [ ${#ARCHIVED_FILES[@]} -eq 0 ]; then
        echo "No files were archived."
    else
        echo "Archive completed successfully. Archived $M files."
        echo "Current disk usage: $CURRENT_USAGE%"
    fi
else
    echo "Threshold not exceeded. No action needed."
fi

exit 0
