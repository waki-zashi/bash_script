#!/bin/bash

set -e

TEST_LOG_DIR="$HOME/test_log"
BACKUP_DIR="$HOME/backup"

# Clean up test directories and create fresh ones
prepare_logs() {
    rm -rf "$TEST_LOG_DIR" "$BACKUP_DIR"
    mkdir -p "$TEST_LOG_DIR" "$BACKUP_DIR"
}

# Test 1: Small files below threshold - should not archive
prepare_logs
for i in {1..5}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/log_$i.txt" bs=1K count=10 &> /dev/null
done
echo "Test 1: Threshold 99% (no archiving) ==="
bash ./log_cleaner.sh "$TEST_LOG_DIR" 99
echo "Backup consists of:"
ls -lh "$BACKUP_DIR" || echo "Folder is empty"

# Test 2: Multiple small files - testing file sorting and selection
prepare_logs
for i in {1..10}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/log_$i.txt" bs=1K count=$((i*5)) &> /dev/null
    sleep 1
done
echo "Test 2: Threshold 1% (archiving)"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
echo "Backup consists of:"
if ls "$BACKUP_DIR"/*.tar.gz > /dev/null 2>&1; then
    ls -lh "$BACKUP_DIR"/*.tar.gz
    echo "Archive contents:"
    tar -tzf "$(ls -t "$BACKUP_DIR"/*.tar.gz | head -1)" 2>/dev/null || echo "Cannot list contents"
else
    echo "No backup files found!"
    echo "DEBUG: Backup dir exists: $(test -d "$BACKUP_DIR" && echo "YES" || echo "NO")"
    echo "DEBUG: Files in backup: $(ls -la "$BACKUP_DIR" 2>/dev/null | wc -l)"
fi

# Test 3: Empty directory handling
prepare_logs
echo "Test 3: Log folder is empty (no archiving)"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
echo "Backup consists of:"
ls -lh "$BACKUP_DIR" || echo "Folder is empty"

# Test 4: Backup directory creation and basic archiving
prepare_logs
rm -rf "$BACKUP_DIR"
for i in {1..3}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/log_$i.txt" bs=1K count=50 &> /dev/null
done
echo "Test 4: backup folder does not exist (creating)"
rm -rf "$BACKUP_DIR"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
echo "Backup: consists of:"
if [ -d "$BACKUP_DIR" ]; then
    ls -lh "$BACKUP_DIR" || echo "Backup directory is empty"
else
    echo "ERROR: Backup directory was not created!"
fi

# Test 5: Verify that backup files are actually created
prepare_logs
for i in {1..5}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/file_$i.log" bs=1M count=20 &> /dev/null
done
echo "Test 5: Verify backup file creation"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
if ls "$BACKUP_DIR"/*.tar.gz > /dev/null 2>&1; then
    echo "PASS: Backup file created successfully"
    ls -lh "$BACKUP_DIR"/*.tar.gz
    echo "Archive contents:"
    tar -tzf "$(ls -t "$BACKUP_DIR"/*.tar.gz | head -1)" 2>/dev/null || echo "Cannot list contents"
else
    echo "FAIL: No backup file found"
    echo "DEBUG: Backup dir exists: $(test -d "$BACKUP_DIR" && echo "YES" || echo "NO")"
fi

# Test 6: Check archive contents and file count
prepare_logs
for i in {1..8}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/logfile_$i.log" bs=1M count=15 &> /dev/null
    sleep 0.1
done
echo "Test 6: Verify archive content"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
archive_file=$(ls "$BACKUP_DIR"/*.tar.gz 2>/dev/null | head -1)
if [ -n "$archive_file" ]; then
    file_count=$(tar -tzf "$archive_file" 2>/dev/null | wc -l)
    echo "PASS: Archive contains $file_count files"
    echo "Archive contents:"
    tar -tzf "$archive_file" 2>/dev/null || echo "Cannot list contents"
else
    echo "FAIL: No archive to check"
    echo "DEBUG: Backup dir contents: $(ls -la "$BACKUP_DIR" 2>/dev/null || echo "empty/missing")"
fi

# Test 7: Low threshold test with small files
prepare_logs
for i in {1..3}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/small_$i.log" bs=1M count=2 &> /dev/null
done
echo "Test 7: Very low threshold (1%)"
bash ./log_cleaner.sh "$TEST_LOG_DIR" 1
echo "Remaining files: $(find "$TEST_LOG_DIR" -type f | wc -l)"
echo "Backup files: $(find "$BACKUP_DIR" -type f | wc -l)"
if ls "$BACKUP_DIR"/*.tar.gz > /dev/null 2>&1; then
    echo "Archive contents:"
    tar -tzf "$(ls -t "$BACKUP_DIR"/*.tar.gz | head -1)" 2>/dev/null || echo "Cannot list contents"
fi

# Test 8: Verify archiving order (oldest files first) - EXTENDED VERSION
prepare_logs
echo "Test 8: Archive order (oldest first)"


for i in {1..8}; do
    dd if=/dev/zero of="$TEST_LOG_DIR/file_$(printf "%02d" $i).log" bs=1M count=5 &> /dev/null
    echo "Created file_$(printf "%02d" $i).log"
    sleep 1
done

echo "Files before archiving (newest first):"
ls -1t "$TEST_LOG_DIR"

bash ./log_cleaner.sh "$TEST_LOG_DIR" 1

echo "Files remaining after archiving:"
find "$TEST_LOG_DIR" -type f -printf '%f\n' 2>/dev/null | sort || echo "none"

echo "Backup verification:"
archive_files=($(ls -t "$BACKUP_DIR"/*.tar.gz 2>/dev/null))
if [ ${#archive_files[@]} -gt 0 ]; then
    for archive in "${archive_files[@]}"; do
        echo "Archive: $(basename "$archive")"
        echo "Contents (archived files in order):"
        tar -tzf "$archive" 2>/dev/null | grep -v '/$' | sort
        echo "---"
    done
    
    latest_archive="${archive_files[0]}"
    archived_files_list=$(tar -tzf "$latest_archive" 2>/dev/null | grep -v '/$')
    
    echo "Archiving order analysis:"
    if echo "$archived_files_list" | head -1 | grep -q "file_01.log"; then
        echo "PASS: Oldest file (file_01.log) was archived first"
    else
        echo "FAIL: Oldest file not archived first"
    fi
    
    archived_count=$(echo "$archived_files_list" | wc -l)
    echo "Total files archived: $archived_count"
else
    echo "No backup archives found"
    echo "DEBUG: Backup dir exists: $(test -d "$BACKUP_DIR" && echo "YES" || echo "NO")"
    echo "DEBUG: Files in backup: $(ls -la "$BACKUP_DIR" 2>/dev/null | wc -l)"
fi

echo "Files remaining in log directory: $(find "$TEST_LOG_DIR" -type f | wc -l)"
echo "---"

# Test 9: Input validation and error handling
prepare_logs
echo "Test 9: Check up entering arguments"

if bash ./log_cleaner.sh "$TEST_LOG_DIR" "abc"; then
    echo "You entered string instead of number"
    exit 1
else
    echo "Script correctly rejected string instead of number"
fi

if bash ./log_cleaner.sh "$TEST_LOG_DIR" -5; then
    echo "You entered negative number"
    exit 1
else
    echo "Script correctly rejected negative number"
fi

if bash ./log_cleaner.sh "$TEST_LOG_DIR" 150; then
    echo "You entered number greater than 100"
    exit 1
else
    echo "Script correctly rejected number greater than 100"
fi

echo "All tests completed"
