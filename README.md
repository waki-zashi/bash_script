# Утилита для очистки логов

## Обзор

Bash-скрипт, который отслеживает использование диска в указанной директории и автоматически архивирует старые файлы логов, когда использование диска превышает заданный порог. Скрипт использует динамический подход к архивации, обрабатывая файлы по одному, пока использование диска не упадет ниже целевого уровня.

## Возможности

- **Мониторинг использования диска**: Постоянно отслеживает процент использования файловой системы
- **Динамическая архивация**: Архивирует файлы по одному, пока использование не упадет ниже порога
- **Настраиваемые пороги**: Пользовательские пороги использования диска с автоматическим расчетом точки срабатывания (70% от пользовательского порога)
- **Сохранение порядка файлов**: Архивирует файлы в хронологическом порядке (самые старые первыми)
- **Управление бэкапами**: Автоматическое создание и управление директорией для бэкапов
- **Валидация входных данных**: Комплексная проверка параметров и обработка ошибок
- **Отслеживание прогресса в реальном времени**: Показывает текущее использование диска после каждой операции с файлом

## Структура проекта

```
log-cleaner/
├── log_cleaner.sh          # Основной скрипт очистки
├── test_log_cleaner.sh     # Комплексный набор тестов
└── README.md              # Этот файл
```

## Требования

- Bash shell
- Стандартные Unix утилиты: `find`, `tar`, `df`, `awk`
- Протестировано на Ubuntu Linux

## Установка

1. Клонируйте репозиторий:
```bash
git clone <URL-репозитория>
cd log-cleaner
```

2. Сделайте скрипты исполняемыми:
```bash
chmod +x log_cleaner.sh test_log_cleaner.sh
```

## Использование

### Основной скрипт

```bash
./log_cleaner.sh <директория_логов> <порог_в_процентах>
```

**Параметры:**
- `директория_логов`: Путь к директории с файлами логов для мониторинга
- `порог_в_процентах`: Порог использования диска в процентах (0-100)

**Примеры:**
```bash
# Мониторинг /var/log с порогом 80%
./log_cleaner.sh /var/log 80

# Мониторинг логов приложения с порогом 50%  
./log_cleaner.sh /opt/app/logs 50
```

### Как это работает

1. **Расчет порога**: Скрипт использует 70% от пользовательского порога как фактическую точку срабатывания
2. **Выбор файлов**: Находит все файлы, отсортированные по времени изменения (самые старые первыми)
3. **Динамическая обработка**: Архивирует файлы по одному, проверяя использование диска после каждой операции
4. **Умная остановка**: Останавливает архивацию, когда использование диска падает ниже расчетного порога
5. **Отслеживание прогресса**: Показывает использование диска в реальном времени и количество файлов

**Логика порогов:**
- Пользователь задает порог (например, 80%)
- Скрипт вычисляет порог срабатывания: 80% × 70% = 56%
- Архивация начинается при использовании > 56%
- Архивация останавливается при использовании ≤ 56%

**Пример вывода:**
```
Directory /var/log uses 75% of filesystem space
Threshold: 80% (action triggered at 56%)
Threshold 56% exceeded. Starting archive...
Archived: /var/log/old_log1.txt (Usage: 70%)
Archived: /var/log/old_log2.txt (Usage: 65%)
Archived: /var/log/old_log3.txt (Usage: 58%)
Archived: /var/log/old_log4.txt (Usage: 55%)
Usage dropped to 55%. Stopping archive.
Archive completed successfully. Archived 4 files.
Current disk usage: 55%
```

## Тестирование

Включен комплексный набор тестов для проверки всей функциональности:

```bash
./test_log_cleaner.sh
```

### Покрытие тестами

Набор тестов проверяет:

1. **Поведение порогов**: Корректная обработка сценариев ниже порога
2. **Архивацию файлов**: Успешную архивацию файлов разных типов и размеров
3. **Пустую директорию**: Корректную обработку директорий без файлов
4. **Директорию бэкапов**: Автоматическое создание директории для бэкапов
5. **Большие файлы**: Архивирование больших файлов (несколько гигабайт)
6. **Проверку содержимого**: Валидацию содержимого архивов и подсчет файлов
7. **Сохранение порядка**: Подтверждение, что самые старые файлы архивируются первыми
8. **Валидацию входных данных**: Корректный отказ невалидных параметров
9. **Динамическую архивацию**: Проверку логики обработки файлов по одному

### Пример вывода тестов

```
================================================================
TEST: 1: Small files below threshold (no archiving expected)
================================================================
PASS: No archives created - threshold not exceeded

================================================================
TEST: 8: Archiving order (oldest first)
================================================================
FILES: Files before archiving (newest first):
file_08.log
file_07.log
...
file_01.log
PASS: Oldest file (file_01.log) archived first
INFO: Total files archived: 8
```

## Конфигурация

### Расположение бэкапов

Архивы сохраняются в: `$HOME/backup/`  
Формат имен архивов: `Log_backup_ГГГГММДД_ЧЧММСС.tar.gz`

### Настройки порогов

Скрипт использует двухуровневую систему порогов:
- **Пользовательский порог**: Процент, заданный пользователем (например, 80%)
- **Порог срабатывания**: 70% от пользовательского порога (например, 56% для пользовательского порога 80%)

Это создает буфер и обеспечивает проактивную очистку до того, как место на диске станет критическим.

## Обработка ошибок

Скрипт предоставляет четкие сообщения об ошибках для распространенных проблем:

- **Невалидные параметры**: Нечисловые пороги, значения вне диапазона
- **Отсутствующие директории**: Исходная директория не найдена
- **Ошибки архивации**: Проблемы с местом на диске или правами доступа
- **Пустые директории**: Нет доступных файлов для архивации
- **Ошибки команды tar**: Проблемы с созданием или добавлением в архив

## Коды выхода

- `0`: Успех
- `1`: Ошибка валидации параметров
- `2`: Директория не найдена
- `3`: Ошибка создания архива

## Сценарии использования

- **Ротация логов**: Автоматическое архивирование старых логов приложения
- **Управление местом на диске**: Предотвращение исчерпания места на диске в директориях с логами
- **Соответствие требованиям**: Сохранение архивных логов для целей аудита
- **Системное администрирование**: Автоматизированная очистка для нескольких директорий с логами
